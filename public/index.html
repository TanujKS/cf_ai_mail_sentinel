<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fail-Safe Email Worker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.95;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section h2 {
            color: #667eea;
            font-size: 1.8em;
            margin-bottom: 15px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .section p {
            margin-bottom: 15px;
            font-size: 1.1em;
            color: #555;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .feature-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .feature-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .feature-card p {
            color: #666;
            font-size: 0.95em;
            margin: 0;
        }

        .tech-stack {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .tech-badge {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .code-block code {
            color: #f8f8f2;
        }

        .status {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin-top: 10px;
        }

        ul {
            list-style-position: inside;
            margin-left: 20px;
        }

        ul li {
            margin-bottom: 8px;
            color: #555;
        }

        .footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            color: #666;
            border-top: 1px solid #e9ecef;
        }

        .example-images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .example-image {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .example-image img {
            width: 100%;
            height: auto;
            border-radius: 4px;
            display: block;
        }

        .example-image h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Fail-Safe Email Worker</h1>
            <p>AI-Powered Email Forwarding with Intelligent Reply Generation</p>
            <div class="status">‚óè Running</div>
        </div>

        <div class="content">
            <div class="section">
                <h2>About</h2>
                <p>
                    Fail-Safe Email Worker is a fully serverless email processing system built on Cloudflare's edge computing platform. 
                    It leverages Cloudflare Email Routing to receive emails, Cloudflare Workers to process them, and Cloudflare AI 
                    with Durable Objects to power an intelligent agent that analyzes customer emails and generates helpful replies. 
                    The agent can also interact with a Google Calendar MCP server (hosted as a separate Cloudflare Worker) for calendar 
                    integration. If delivery fails, emails are automatically saved to Cloudflare R2 Storage and alerts are sent via Discord webhook.
                </p>
            </div>

            <div class="section">
                <h2>Key Features</h2>
                <div class="features">
                    <div class="feature-card">
                        <h3>ü§ñ AI-Powered Analysis</h3>
                        <p>Uses Cloudflare AI agents to analyze incoming emails and generate intelligent, context-aware replies to customers.</p>
                    </div>
                    <div class="feature-card">
                        <h3>üìß Smart Email Routing</h3>
                        <p>Routes emails to different addresses based on recipient with support for exact matches, catch-all patterns, and global defaults.</p>
                    </div>
                    <div class="feature-card">
                        <h3>üíæ Automatic Backup</h3>
                        <p>Automatically saves failed or spam emails to Cloudflare R2 bucket storage with full metadata for later retrieval and analysis.</p>
                    </div>
                    <div class="feature-card">
                        <h3>üîî Discord Alerts</h3>
                        <p>Real-time notifications via Discord webhook when email delivery fails, including full error details and email content.</p>
                    </div>
                    <div class="feature-card">
                        <h3>üîÑ Fail-Safe Design</h3>
                        <p>Comprehensive error handling ensures emails are never lost, with multiple fallback mechanisms in place.</p>
                    </div>
                    <div class="feature-card">
                        <h3>üìù Email Threading</h3>
                        <p>Maintains proper email threading with In-Reply-To headers and quoted message formatting for seamless conversations.</p>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>How It Works</h2>
                <ol style="margin-left: 20px; color: #555;">
                    <li style="margin-bottom: 10px;"><strong>Email Reception:</strong> Cloudflare Email Routing receives incoming emails and routes them to the Cloudflare Worker.</li>
                    <li style="margin-bottom: 10px;"><strong>AI Analysis:</strong> The AI agent (running on Cloudflare Workers with Durable Objects) analyzes the email content to determine if an automated reply is appropriate. The agent can also leverage the Google Calendar MCP server (hosted as a separate Cloudflare Worker) for calendar-related queries.</li>
                    <li style="margin-bottom: 10px;"><strong>Reply Generation:</strong> If appropriate, the agent generates a helpful reply using Cloudflare AI and sends it to the customer via Mailgun.</li>
                    <li style="margin-bottom: 10px;"><strong>Email Forwarding:</strong> The original email (or agent-replied chain) is forwarded to the configured target address.</li>
                    <li style="margin-bottom: 10px;"><strong>Error Handling:</strong> If forwarding fails, the email is automatically saved to Cloudflare R2 Storage for backup and a Discord alert is sent.</li>
                </ol>
            </div>

            <div class="section">
                <h2>Technology Stack</h2>
                <p style="margin-bottom: 20px;">
                    This application is built entirely on Cloudflare's edge computing platform, leveraging multiple Cloudflare products for a fully serverless, scalable solution:
                </p>
                <div class="tech-stack">
                    <span class="tech-badge">Cloudflare Email Routing</span>
                    <span class="tech-badge">Cloudflare Workers</span>
                    <span class="tech-badge">Cloudflare AI</span>
                    <span class="tech-badge">Cloudflare Durable Objects</span>
                    <span class="tech-badge">Cloudflare R2 Storage</span>
                    <span class="tech-badge">Mailgun</span>
                    <span class="tech-badge">Discord Webhooks</span>
                </div>
                <div style="margin-top: 25px;">
                    <h3 style="color: #667eea; font-size: 1.3em; margin-bottom: 15px;">Cloudflare Infrastructure</h3>
                    <ul style="list-style: none; padding-left: 0;">
                        <li style="margin-bottom: 12px;">
                            <strong style="color: #667eea;">Cloudflare Email Routing:</strong> Routes incoming emails directly to the worker, eliminating the need for traditional email servers.
                        </li>
                        <li style="margin-bottom: 12px;">
                            <strong style="color: #667eea;">Cloudflare Workers:</strong> The main email processing worker handles all incoming emails and orchestrates the AI agent interactions. Additionally, a separate worker hosts the Google Calendar MCP (Model Context Protocol) server, providing calendar integration capabilities to the AI agent.
                        </li>
                        <li style="margin-bottom: 12px;">
                            <strong style="color: #667eea;">Cloudflare AI:</strong> Powers the intelligent email analysis and automated reply generation using state-of-the-art language models.
                        </li>
                        <li style="margin-bottom: 12px;">
                            <strong style="color: #667eea;">Cloudflare Durable Objects:</strong> Provides stateful, per-customer conversation context for the AI agent, enabling intelligent multi-turn conversations with email threading.
                        </li>
                        <li style="margin-bottom: 12px;">
                            <strong style="color: #667eea;">Cloudflare R2 Storage:</strong> Automatically stores failed or spam emails in R2 buckets for backup, analysis, and compliance purposes. All email data is securely stored with full metadata.
                        </li>
                    </ul>
                </div>
            </div>

            <div class="section">
                <h2>Testing the Agent</h2>
                <p>
                    You can test the AI-powered email agent by sending an email to <strong style="color: #667eea; font-size: 1.1em;">agent@tanuj.xyz</strong>.
                </p>
                <p style="margin-top: 15px;">
                    When you send an email to this address:
                </p>
                <ol style="margin-left: 20px; color: #555; margin-top: 10px;">
                    <li style="margin-bottom: 10px;"><strong>Cloudflare Email Routing</strong> receives your email and routes it to the worker.</li>
                    <li style="margin-bottom: 10px;">The <strong>Cloudflare Worker</strong> extracts and analyzes your email content.</li>
                    <li style="margin-bottom: 10px;">The <strong>AI Agent</strong> (powered by Cloudflare AI and Durable Objects) processes your email and determines if an automated reply is appropriate.</li>
                    <li style="margin-bottom: 10px;">If the agent decides to reply, it generates a helpful response using AI and sends it back to you via Mailgun.</li>
                    <li style="margin-bottom: 10px;">The original email (with the agent's reply chain) is forwarded to the configured destination address.</li>
                    <li style="margin-bottom: 10px;">If any step fails, the email is automatically saved to <strong>Cloudflare R2 Storage</strong> for backup and analysis.</li>
                </ol>
                <p style="margin-top: 20px; padding: 15px; background: #f0f4ff; border-left: 4px solid #667eea; border-radius: 4px;">
                    <strong>üí° Try it out:</strong> Send a customer service inquiry, question, or request to <strong>agent@tanuj.xyz</strong> and watch the AI agent respond intelligently!
                </p>
                
                <div style="margin-top: 30px;">
                    <h3 style="color: #667eea; font-size: 1.3em; margin-bottom: 15px;">Example Conversations</h3>
                    <div class="example-images">
                        <div class="example-image">
                            <h4>Product Inquiry</h4>
                            <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">The agent answers product questions using the product catalog tools.</p>
                            <img src="/inquiry.png" alt="Example email conversation showing product inquiry" />
                        </div>
                        <div class="example-image">
                            <h4>Consultation Scheduling</h4>
                            <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">The agent schedules consultations using Google Calendar integration.</p>
                            <img src="/consultation.png" alt="Example email conversation showing consultation scheduling" />
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Configuration</h2>
                <p>Email routing is configured via environment variables in <code>wrangler.jsonc</code>:</p>
                <div class="code-block">
<code>{
  "EMAIL_ROUTING": {
    "user@domain.com": "target@domain.com",
    "@domain.com": "catchall@domain.com",
    "@default": "fallback@domain.com"
  }
}</code>
                </div>
                <p>Supports:</p>
                <ul>
                    <li><strong>Exact matches:</strong> Route specific email addresses to target addresses</li>
                    <li><strong>Catch-all routing:</strong> Route all emails for a domain to a single address</li>
                    <li><strong>Global default:</strong> Fallback routing for unmatched emails</li>
                </ul>
            </div>

            <div class="section">
                <h2>Monitoring & Alerts</h2>
                <p>The worker provides comprehensive monitoring capabilities:</p>
                <ul>
                    <li>Cloudflare Workers logs for email processing status</li>
                    <li>Cloudflare R2 bucket storage for failed email and spam backups</li>
                    <li>Discord webhook alerts with detailed error information</li>
                    <li>Real-time status tracking and error reporting</li>
                    <li>Full email metadata stored in R2 for compliance and analysis</li>
                </ul>
            </div>
        </div>

        <div class="footer">
            <p>Built with ‚ù§Ô∏è using Cloudflare Workers and AI</p>
            <p style="margin-top: 10px; font-size: 0.9em;">Fail-Safe Email Worker v1.0</p>
        </div>
    </div>
</body>
</html>
